// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String?
  username        String?   // è¡¨ç¤ºå
  uniqueId        String    @unique // å…¬é–‹ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¾‹: @user123ï¼‰å¿…é ˆ
  avatarEmoji     String?   // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµµæ–‡å­—ï¼ˆä¾‹: ğŸ˜€, ğŸ¨, ğŸš€ï¼‰
  uniqueIdChangedAt DateTime? // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå¤‰æ›´æ—¥ï¼ˆ1ãƒ¶æœˆåˆ¶é™ç”¨ï¼‰
  emailVerified   Boolean   @default(false) // ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹
  emailVerificationToken String? @unique // ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
  emailVerificationTokenExpires DateTime? // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™
  isAdmin         Boolean   @default(false)
  isSuspended     Boolean   @default(false)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  activities      Activity[]
  insights        Insight[]
  categories      Category[]
  ownedGroups     Group[]        @relation("GroupOwner")
  groupMemberships GroupMember[]

  @@map("users")
}

model Category {
  id        String   @id @default(cuid())
  userId    String
  name      String   // ã‚«ãƒ†ã‚´ãƒªå
  emoji     String   // çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³
  color     String   // ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ (hex)
  isDefault Boolean  @default(false) // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã‹ã©ã†ã‹
  sortOrder Int      @default(0)     // ä¸¦ã³é †
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("categories")
  @@index([userId, sortOrder])
}

model Activity {
  id              String   @id @default(cuid())
  userId          String
  title           String
  category        String   // ã‚«ãƒ†ã‚´ãƒªå
  durationMinutes Int
  mood            Int      // 1-5
  note            String?
  date            String   // YYYY-MM-DD format
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedToGroups  GroupSharedActivity[]

  @@map("activities")
  @@index([userId, date])
  @@index([category])
}

model Insight {
  id            String   @id @default(cuid())
  userId        String
  summary       String
  advice        String
  startDate     String   // YYYY-MM-DD format
  endDate       String   // YYYY-MM-DD format
  category      String?  // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ã—ãŸå ´åˆã®ã‚«ãƒ†ã‚´ãƒªå
  activityCount Int
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("insights")
  @@index([userId, createdAt])
}

// ã‚°ãƒ«ãƒ¼ãƒ—
model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  inviteCode  String   @unique // æ‹›å¾…URLç”¨ã®ã‚³ãƒ¼ãƒ‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner             User                  @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members           GroupMember[]
  sharedCategories  GroupCategory[]
  sharedActivities  GroupSharedActivity[]
  groupInsights     GroupInsight[]

  @@map("groups")
  @@index([ownerId])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼
model GroupMember {
  id       String   @id @default(cuid())
  groupId  String
  userId   String
  role     String   @default("member") // 'owner' | 'member'
  joinedAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
  @@index([groupId])
  @@index([userId])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ã§å…±æœ‰ã™ã‚‹ã‚«ãƒ†ã‚´ãƒª
model GroupCategory {
  id           String @id @default(cuid())
  groupId      String
  categoryName String // ã‚«ãƒ†ã‚´ãƒªå

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, categoryName])
  @@map("group_categories")
  @@index([groupId])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ã«å…±æœ‰ã•ã‚ŒãŸæ´»å‹•
model GroupSharedActivity {
  id         String   @id @default(cuid())
  groupId    String
  activityId String
  sharedAt   DateTime @default(now())

  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([groupId, activityId])
  @@map("group_shared_activities")
  @@index([groupId])
  @@index([activityId])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ï¼‰
model GroupInsight {
  id            String   @id @default(cuid())
  groupId       String
  userId        String   // ã‚¤ãƒ³ã‚µã‚¤ãƒˆå¯¾è±¡ã®ãƒ¡ãƒ³ãƒãƒ¼
  summary       String
  advice        String
  startDate     String
  endDate       String
  activityCount Int
  createdAt     DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_insights")
  @@index([groupId, userId])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
model GroupMessage {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  content   String
  createdAt DateTime @default(now())

  @@map("group_messages")
  @@index([groupId, createdAt])
  @@index([userId])
}

// ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ï¼ˆAPIä½¿ç”¨çŠ¶æ³ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼‰
model SystemLog {
  id        String   @id @default(cuid())
  type      String   // 'api_call' | 'error' | 'llm_call' | 'auth'
  method    String?  // HTTP method
  path      String?  // API path
  userId    String?  // User who made the request
  status    Int?     // HTTP status code
  duration  Int?     // Response time in ms
  message   String?  // Error message or description
  metadata  String?  // JSON string for additional data
  createdAt DateTime @default(now())

  @@map("system_logs")
  @@index([type, createdAt])
  @@index([userId, createdAt])
}

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

